<!DOCTYPE html>
<html>
  <h1>WebSocket Client</h1>
  <div id="app">
    <button v-on:click="this.connect">Connect</button>
    <button v-on:click="this.send">Send</button>
    <button v-on:click="this.disconnect">Disconnect</button>
    <pre>{{ messages.join('\n') }}</pre>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script>
    new Vue({
      el: '#app',
      data: {
        endpoint: '',
        messages: [],
        websocket: undefined
      },
      methods: {
        connect() {
          /*
           * See https://html.spec.whatwg.org/multipage/indices.html#events-2
           * for details around each WebSocket event type.
           */

          // WebSocket sends a message to API Gateway on creation that gets
          // routed to the '$connect' route
          const websocket = this.websocket = new WebSocket(this.endpoint);

          websocket.onclose = ({ wasClean, code, reason }) => {
            this.messages.push(JSON.stringify({ wasClean, code, reason }));
          };

          websocket.onerror = error => {
            this.messages.push(`An error occurred: ${error}`);
          };

          websocket.onmessage = ({ data }) => {
            this.messages.push(data);
          };

          websocket.onopen = () => {
            this.messages.push(`Connected successfully at ${new Date()}.`);
          };
        },
        send() {
          // API gateway will route this message to the 'test' route. If that
          // route isn't defined in serverless.yaml, API Gateway will route it
          // to the '$default' route.
          this.websocket.send({ action: 'test', message: 'hello world' });
        },
        disconnect() {
          // WebSocket sends a message to API Gateway that gets routed to the
          // '$disconnect' route.
          this.websocket.close();
        }
      },
      async beforeCreate() {
        const response = await fetch('./data.json');
        const { ServiceEndpointWebsocket } = await response.json();
        this.endpoint = ServiceEndpointWebsocket;
      }
    })
  </script>
</html>
